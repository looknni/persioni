#!/bin/sh
# /rom/etc/uci-defaults/ ./package/base-files/files/etc/uci-defaults/
touch /root/.vimrc
i41p='i41p'
i61p='i61p'
m1m='m1m'
tables='fw4'
a="export PS1='\[\e[1;95m\]\W \[\e[1;33m\]\\$ \[\e[0m\]'"
nl=25
st2=$(dd if=/dev/urandom bs=1 count=1|hexdump -e '1 "%01x"')
st4=$(dd if=/dev/urandom bs=2 count=1|hexdump -e '1 "%04x"')
r16r=$((16+$RANDOM%16))
r255r=$((RANDOM%255))
if $(uci get network.lan.ipaddr | grep -q '/');then
	uci set network.lan.ipaddr="172.${r16r}.${r255r}.1/24"
else
	uci set network.lan.ipaddr="172.${r16r}.${r255r}.1"
fi
nip=$(uci get network.lan.ipaddr|awk -F '/' '{print $1}')
uci commit
if [ -d "/etc/profile.d/" ] ; then
	echo ${a} > /etc/profile.d/z99.sh
else
	mkdir /etc/profile.d
	echo ${a} > /etc/profile.d/z99.sh
fi
unset a
cat > /root/hts.sh << 'GHTTPS'
openssl ecparam -name prime256v1 -out /etc/ecparam.pem
openssl req -new -newkey ec:/etc/ecparam.pem -days 555 -nodes -x509 -keyout /etc/uhttpd.key -out /etc/uhttpd.crt -subj "/C=CN/ST=st/L=l/O=o/OU=ou/CN=cn/emailAddress=email@emil.com"
openssl ecparam -name prime256v1 -out /etc/radius/ecparam.pem
openssl req -new -newkey ec:/etc/radius/ecparam.pem -days 555 -nodes -x509 -keyout /etc/radius/key.pem -out /etc/radius/cert.pem -subj "/C=CN/ST=st/L=l/O=o/OU=ou/CN=cn/emailAddress=email@emil.com"
openssl req -new -newkey ec:/etc/ecparam.pem -nodes -keyout /etc/radius/server.key -out /etc/radius/server.csr -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=cn"
openssl x509 -req -in /etc/radius/server.csr -CA /etc/radius/cert.pem -CAkey /etc/radius/key.pem -CAcreateserial -out /etc/radius/ca.pem -days 555
uci batch << WW
delete uhttpd.main.listen_http
del_list uhttpd.main.listen_https='[::]:443'
delete uhttpd.defaults
set uhttpd.main.redirect_https='0'
set uhttpd.main.max_connections='1'
set network.@device[0].stp='1'
set network.@device[0].igmp_snooping='1'
set network.@device[0].arp_accept='0'
set network.@device[0].drop_gratuitous_arp='1'
set network.@device[0].drop_unsolicited_na='1'
set network.@device[0].rpfilter='strict'
set network.@device[0].ip6segmentrouting='1'
set network.@device[0].igmpversion='3'
set network.@device[0].mldversion='2'
commit
WW
echo -e 'net.core.default_qdisc = fq\n# hybla bbr\nnet.ipv4.tcp_congestion_control = bbr' >> /etc/sysctl.conf
sysctl -p
GHTTPS

cat > /root/nft.init.0 << EXO
#!/bin/sh
set -e
set -o pipefail
case "\$1" in
	i4 )
		nft add element inet ${tables} ${i41p} {"\$2"}
		;;
	i6 )
		nft add element inet ${tables} ${i61p} {"\$2"}
		;;
	im )
		nft add element inet ${tables} ${m1m} {"\$2"}
		;;
	i4d )
		nft delete element inet ${tables} ${i41p} {"\$2"}
		;;
	i6d )
		nft delete element inet ${tables} ${i61p} {"\$2"}
		;;
	imd )
		nft delete element inet ${tables} ${m1m} {"\$2"}
		;;
	is )
		nft list set inet ${tables} ${i41p} | sed '1d;\$d' > /etc/nftables.d/i41p
		nft list set inet ${tables} ${i61p} | sed '1d;\$d' > /etc/nftables.d/i61p
		;;
	m )
		nft list set inet ${tables} ${m1m} | sed '1d;\$d' > /etc/nftables.d/m1m
		;;
esac
EXO

touch /etc/dropbear/authorized_keys
pd="fe80::${nip}"
(echo ${pd};sleep 1;echo ${pd}) | passwd > /dev/null

rm /etc/nftables.d/*
echo -e "set i41p {\n\ttype ipv4_addr\n\tflags interval\n}" > /etc/nftables.d/i41p
echo -e "set i61p {\n\ttype ipv6_addr\n\tflags interval\n}" > /etc/nftables.d/i61p
echo -e "set m1m {\n\ttype ether_addr\n\tflags interval\n}" > /etc/nftables.d/m1m

cat > /etc/nftables.d/u.nft << NFTC
include "/etc/nftables.d/i41p"
include "/etc/nftables.d/i61p"
include "/etc/nftables.d/m1m"
chain upi {
	type filter hook input priority -1; policy accept;
	ip saddr @${i41p} drop
	ip6 saddr @${i61p} drop
	ether saddr @${m1m} drop
}

chain upf {
	type filter hook forward priority -1; policy accept;
	ip daddr @${i41p} drop comment "drop ct state all"
	ip6 daddr @${i61p} drop
#	ip daddr {192.168.0.3} tcp dport {80,443} drop comment "drop ct state all"
#	ip daddr {192.168.0.3} tcp dport 22 limit rate 10/second log prefix "--- "
	ether saddr @${m1m} drop
}

chain upo {
	type filter hook output priority -1; policy accept;
}

chain udn {
	type nat hook prerouting priority dstnat; policy accept;
#	iifname "br-lan" ip daddr {192.168.1.2} tcp dport {80,443} dnat to ${nip}
}

NFTC

if $(fw_printenv|grep -q 'model=RB03') && [[ -z $(uci get wireless.radio1.path 2>/dev/null) ]];then
	uci set wireless.radio0.path='platform/18000000.wmac'
	uci set wireless.radio1.path='1a143000.pcie/pci0000:00/0000:00:00.0/0000:01:00.0'
	uci commit
fi
[[ $(uci get wireless.radio0.channel) = '1' ]] && {
	uci set wireless.radio0.channel=$((5+$RANDOM%5))
	uci set wireless.radio1.channel=$((153+$RANDOM%3*4))
	uci set wireless.radio0.htmode='HT40'
	uci set wireless.radio0.noscan='1'
	uci set wireless.radio1.disabled='0'
	uci set wireless.default_radio1.disabled='0'
	uci set wireless.default_radio0.disabled='1'
	uci commit
}
[[ $(uci get wireless.radio1.channel) = '1' ]] && {
	uci set wireless.radio1.channel=5
	uci set wireless.radio0.channel=153
	uci set wireless.radio1.htmode='HT40'
	uci set wireless.radio1.noscan='1'
	uci set wireless.radio0.disabled='0'
	uci set wireless.default_radio0.disabled='0'
	uci set wireless.default_radio1.disabled='1'
	uci commit
}
uci batch << EEOO
set dropbear.main.DirectInterface='lan'
set network.globals.packet_steering='2'
set network.globals.tcp_l3mdev='1'
set network.globals.udp_l3mdev='1'
set network.globals.steering_flows='128'
set dhcp.odhcpd.loglevel='1' #4
set dhcp.lan.limit="${nl}"
set dhcp.@dnsmasq[0].domain='o'
set dhcp.@dnsmasq[0].local='/o/'
set dhcp.@dnsmasq[0].cachesize="$((nl*15))"
set dhcp.lan.leasetime='3h'
set firewall.@defaults[0].synflood_protect='1'
set firewall.@defaults[0].flow_offloading='0'
set firewall.@defaults[0].flow_offloading_hw='0'
set system.@system[0].hostname="${st2}"
set system.@system[0].timezone='CST-8'
set system.@system[0].zonename='Asia/Shanghai'
set system.ntp.enable_server='0'
set system.ntp.interface='lan'
add_list dhcp.lan.dhcp_option="3,${nip}"
add_list dhcp.lan.dhcp_option='6,114.114.114.114'
set wireless.radio0.country='CN'
set wireless.radio1.country='CN'
set wireless.default_radio0.ssid="xiaomi-${st4}"
set wireless.default_radio0.encryption='psk2+ccmp'
set wireless.default_radio0.key='00001111'
set wireless.default_radio0.wpa_disable_eapol_key_retries='1'
set wireless.default_radio0.ieee80211w='2'
set wireless.default_radio0.ocv='1'
set wireless.default_radio0.multicast_to_unicast_all='1'
set wireless.default_radio0.time_advertisement='2'
set wireless.default_radio0.time_zone='HKT-8'
set wireless.default_radio0.bss_transition='1'
set wireless.default_radio1.ssid="redmi-${st4}"
set wireless.default_radio1.encryption='psk2+ccmp'
set wireless.default_radio1.key='00001111'
set wireless.default_radio1.wpa_disable_eapol_key_retries='1'
set wireless.default_radio1.ieee80211w='2'
set wireless.default_radio1.ocv='1'
set wireless.default_radio1.multicast_to_unicast_all='1'
set wireless.default_radio1.time_advertisement='2'
set wireless.default_radio1.time_zone='HKT-8'
set wireless.default_radio1.bss_transition='1'
commit
EEOO
verx=$(cat /etc/openwrt_version|awk -F '-' '{print $1}'|grep -Eo "[0-9]{5}")
if [ "${verx}" -ge "32353" ] ;then
fi
exit 0 
